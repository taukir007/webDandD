name: Generate folder list JSON

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Generate folder listing JSON
        run: |
          python3 <<'EOF'
          import os, json, re

          root = os.getcwd()
          out = []
          skip_dirs = {'.github', 'data', '.git'}

          def safe_read_json(path):
            try:
              with open(path, 'r', encoding='utf-8') as f:
                return json.load(f)
            except:
              return None

          for entry in sorted(os.listdir(root)):
            entry_path = os.path.join(root, entry)
            if not os.path.isdir(entry_path):
              continue
            if entry in skip_dirs:
              continue

            index_path = os.path.join(entry_path, 'index.html')
            has_index = os.path.isfile(index_path)

            meta_path = os.path.join(entry_path, 'meta.json')
            meta = safe_read_json(meta_path)

            description = ""
            if isinstance(meta, dict):
              desc = meta.get("description") or meta.get("desc") or meta.get("short") or ""
              if isinstance(desc, str):
                desc = re.sub(r"\s+", " ", desc).strip()
                if len(desc) > 200:
                  desc = desc[:197] + "..."
                description = desc

            out.append({
              "name": entry,
              "path": entry,
              "index": has_index,
              "description": description
            })

          os.makedirs("data", exist_ok=True)
          with open("data/folders.json", "w", encoding="utf-8") as f:
            json.dump(out, f, ensure_ascii=False, indent=2)

          print("Generated data/folders.json with", len(out), "entries")
          EOF

      - name: Commit JSON
        uses: EndBug/add-and-commit@v9
        with:
          add: "data/folders.json"
          message: "Update folder listing JSON"
